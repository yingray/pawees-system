image: williamyeh/ansible:ubuntu16.04

stages:
  # - test
  - deploy

before_script:
  # - git config --global user.email "lu.yingray@gmail.com"
  # - git config --global user.name "Yingray Lu"
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

  - cd ansible
  - mkdir group_vars
  - echo "$ANSIBLE_HOSTS" > hosts
  - echo "$ANSIBLE_VARS" > group_vars/all
  - cd -

# unit test
# test:
#   script:
#     - cd node
#     - yarn
#     - npm test
#   stage: test
#   only:
#     - branches


# minor_release:
#   script:
#     - bash ./scripts/minor_release.bash
#   stage: release
#   when: manual
#   only:
#     - master@yingray/pawees-system

deploy:
    - ansible-playbook -i ./ansible/hosts -u yingray.lu ./ansible/deployment.yml
  stage: deploy
  when: manual
  only:
    - master@yingray/pawees-system
